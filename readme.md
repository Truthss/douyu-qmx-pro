# 斗鱼全民星推荐Pro

[![版本](https://img.shields.io/badge/Version-2.0.4-blue.svg)](https://greasyfork.org/zh-CN/scripts/543589-%E6%96%97%E9%B1%BC%E5%85%A8%E6%B0%91%E6%98%9F%E6%8E%A8%E8%8D%90%E8%87%AA%E5%8A%A8%E9%A2%86%E5%8F%96pro)[![许可证](https://img.shields.io/badge/License-MIT-green.svg)](https://opensource.org/licenses/MIT)[![原作者](https://img.shields.io/badge/Original-ysl--ovo-orange.svg)](https://greasyfork.org/zh-CN/users/1453821-ysl-ovo)

用于自动领取斗鱼【全民星推荐】活动红包的油猴脚本。本脚本基于 [ysl-ovo 的原版脚本](https://greasyfork.org/zh-CN/scripts/532514-%E6%96%97%E9%B1%BC%E5%85%A8%E6%B0%91%E6%98%9F%E6%8E%A8%E8%8D%90%E8%87%AA%E5%8A%A8%E9%A2%86%E5%8F%96) 进行二次开发，在保留核心功能的基础上，重构了整体架构并新增了可视化管理面板。

---
## 关于斗鱼新版界面的说明

- 由于目前我还没被灰度到斗鱼新版UI，因此无法确认新版星推荐红包/切换回旧版相关页面元素的具体情况，进而暂时无法进行适配和调试。
- 后续如有条件将会进行更新，或者有能看到的朋友们能进行修改……
- 已发布 [v2.0.4a 预发布版](https://github.com/ienone/douyu-qmx-pro/releases/tag/v.2.0.4a) 尝试解决新版UI问题。但据[用户反馈](https://github.com/ienone/douyu-qmx-pro/issues/3#issuecomment-3194206924)，返回旧版的按钮可能已不存在，欢迎测试

---

## 用户界面 (UI)

![alt text](demo.gif)
![侧边栏模式的面板界面](menu.png)
![设置界面](setting.png)
---

## ✨ 相较于原版的改进

1.  改用“控制中心”模式

    原来的脚本是每个标签页独立工作，现在改成了在一个固定的控制页面（比如6657）来统一管理所有后台的工作标签页。这样做的好处是脚本不会因为单个标签页崩溃就完全停止，也让下面的可视化管理成为可能。

2.  增加了一个可视化面板

    现在控制页上会有一个面板，可以显示所有正在运行的直播间列表。你能从面板上直接看到每个房间的主播名，以及它们是正在倒计时、还是正在领红包。如果哪个标签页卡住了，也可以从面板上单独关掉它。

3.  优化了后台运行的稳定性

    针对浏览器长时间后台会“冻结”标签页的问题做了一些处理。现在，如果一个标签页因为在后台太久而没反应，它会在面板上被标记为“无响应”，而不是直接消失，方便你切换过去激活它。同时，脚本会尝试在倒计时快结束时设置一个定时器来唤醒自己，以提高在后台抢到红包的成功率。

4.  提供了图形化设置

    做了一个有多项分类的设置界面。一些常用的选项，比如同时开多少个标签页、各种超时时间等，都可以在设置里修改，不用再改代码了。



## ⚙️ 设置详解

通过点击控制面板上的【设置】按钮，可以打开详细的配置界面。

### 基本设置
| 设置项 | 说明 |
| :--- | :--- |
| 控制室房间号 | 警告： 插件UI的入口点。只有在这个房间才能看到控制面板，防止输错了就找不到了，谨慎修改。 |
| 自动暂停后台视频 | 开启后，脚本会自动暂停非活动直播间的视频播放，降低资源占用。 |
| 达到上限后的行为 | `直接关停`: 当天任务完成后关闭所有工作标签页。<br>`进入休眠模式`: 任务完成后标签页不关闭，而是等待午夜12点后自动刷新页面，开始新一天的任务。|
| 控制中心显示模式| `浮动窗口`: 可拖拽的独立窗口。<br>`屏幕居中`: 固定的居中模态框。<br>`替换排行榜显示`: 面板会嵌入替换直播间右侧的排行榜区域，网页模式也可见。 |

### 时间设定
| 设置项 | 说明 | 默认值 |
| :--- | :--- | :--- |
| 标签页最大生存时间 | 为防止未知错误导致卡死，单个标签页在此时间后会自动切换。 | 10分钟 |
| 无活动时切换延迟 | 当红包区域持续消失达到此时长后，脚本会判定此房间无效并自动切换。 | 30秒 |
| 主循环检查间隔 | 脚本检查红包状态的频率。值越小反应越快，但CPU占用越高。 | 1s |
| 红包弹窗等待超时 | 点击红包后，等待开奖弹窗出现的最长时间。 | 20s |
| 工作页失联超时 | 标签页多久没更新心跳就会被标记为“无响应”。 | 30s |
| 工作页加载超时 | 新开的标签页在此时间内未能完成加载，则判定为失败并切换。 | 45s |

### 高级设置
| 设置项 | 说明 | 默认值 |
| :--- | :--- | :--- |
| 最大工作标签页数量 | 同时运行的直播间总数，这是影响性能的最主要因素。 | 24 |
| 单次API获取房间数 | 每次点击“打开新房间”时，从API获取的备选房间数量。 | 10 |
| API请求重试次数 | 网络请求失败时的自动重试次数。 | 3 |
| API重试延迟 | 每次API请求失败后，等待多久再重试。 | 5s |
| 打开标签页延迟 | 打开新页面后，旧页面等待多久再开始关闭流程。 | 1s |
| 关闭标签页延迟 | 旧页面在关闭自己前的最后等待时间。 | 1.5s |

---

## 📖 关于 (About)

这部分内容与脚本设置面板中的“关于”页同步。

#### 致谢
本脚本基于 [ysl-ovo](https://greasyfork.org/zh-CN/users/1453821-ysl-ovo) 的插件 [《斗鱼全民星推荐自动领取》](https://greasyfork.org/zh-CN/scripts/532514-%E6%96%97%E9%B1%BC%E5%85%A8%E6%B0%91%E6%98%9F%E6%8E%A8%E8%8D%90%E8%87%AA%E5%8A%A8%E9%A2%86%E5%8F%96) 进行功能改进与界面美化，同样遵循MIT许可证开源。感谢原作者的分享。

#### 一些Tips
*   新开的后台直播间可能因浏览器策略不加载，手动切换过去几秒即可。
*   标签页在后台久了可能被标记为“无响应”，同样是切换激活一下就能恢复心跳。
*   由于后台定时器限制，倒计时结束时可能无法立即响应，可以到点后手动切过去抢。
*   脚本bug不少，目前只能说勉强能跑。但时间精力有限暂时不打算改了＞︿＜

#### 源码与社区
*   可以在 [GitHub](https://github.com/ienone/eilatam) 查看本脚本源码。
*   发现BUG或有功能建议，欢迎提交 [Issue](https://github.com/ienone/eilatam/issues)（不过大概率不会修……）。
*   如果你有能力进行改进，非常欢迎提交 [Pull Request](https://github.com/ienone/eilatam/pulls)！

## 📄 许可证 (License)

本脚本使用 [MIT License](https://opensource.org/licenses/MIT) 授权。
